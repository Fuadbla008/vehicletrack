<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner App</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center">

<div id="app" class="w-full max-w-md p-6"></div>

<script>
/* ================= CONFIG ================= */
const SHEET_API_URL = "PASTE_GOOGLE_SCRIPT_WEBAPP_URL";

/* ================= USERS ================= */
const users = [
  { username: "user1", password: "pass1" },
  { username: "user2", password: "pass2" },
  { username: "user3", password: "pass3" }
];

let currentUser = null;
let scannedData = null;
let qr = null;
let latitude = null;
let longitude = null;

/* ================= DEVICE ID ================= */
function getDeviceId() {
  let id = localStorage.getItem("device_id");
  if (!id) {
    id = "DEV-" + crypto.randomUUID();
    localStorage.setItem("device_id", id);
  }
  return id;
}

/* ================= LOCATION ================= */
function getLocation() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      resolve({ lat: "N/A", lon: "N/A" });
      return;
    }

    navigator.geolocation.getCurrentPosition(
      pos => resolve({
        lat: pos.coords.latitude,
        lon: pos.coords.longitude
      }),
      () => resolve({ lat: "Denied", lon: "Denied" }),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

/* ================= UI ================= */
function renderLogin() {
  app.innerHTML = `
    <h1 class="text-2xl font-bold mb-6 text-center">QR Scanner Login</h1>

    <input id="username" class="w-full p-3 mb-3 rounded bg-slate-800" placeholder="Username">
    <input id="password" type="password" class="w-full p-3 mb-4 rounded bg-slate-800" placeholder="Password">

    <button id="loginBtn" class="w-full bg-blue-600 p-3 rounded">Login</button>
    <p id="error" class="text-red-400 mt-3 text-center"></p>
  `;
  loginBtn.onclick = login;
}

function renderScanner() {
  app.innerHTML = `
    <div class="flex justify-between mb-4">
      <p>ðŸ‘¤ ${currentUser}</p>
      <button onclick="logout()" class="text-red-400">Logout</button>
    </div>

    <button id="scanBtn" class="w-full bg-green-600 p-3 rounded mb-4">Scan QR</button>

    <div id="reader" class="hidden"></div>

    <div id="preview" class="hidden mt-4">
      <div id="data" class="bg-slate-800 p-3 rounded mb-3 break-all"></div>
      <button id="submitBtn" class="w-full bg-blue-600 p-3 rounded">Submit</button>
    </div>
  `;
  scanBtn.onclick = startScan;
  submitBtn.onclick = submitData;
}

/* ================= LOGIC ================= */
function login() {
  const u = username.value.trim();
  const p = password.value.trim();

  const ok = users.find(x => x.username === u && x.password === p);
  if (!ok) return error.textContent = "Invalid Login";

  currentUser = u;
  renderScanner();
}

function logout() {
  currentUser = null;
  scannedData = null;
  if (qr) qr.stop().catch(()=>{});
  renderLogin();
}

function startScan() {
  reader.classList.remove("hidden");
  scanBtn.classList.add("hidden");

  qr = new Html5Qrcode("reader");
  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async (txt) => {
      scannedData = txt;
      qr.stop();

      const loc = await getLocation();
      latitude = loc.lat;
      longitude = loc.lon;

      reader.classList.add("hidden");
      preview.classList.remove("hidden");
      data.textContent = scannedData;
    }
  );
}

async function submitData() {
  const payload = {
    username: currentUser,
    qr_data: scannedData,
    device_id: getDeviceId(),
    latitude,
    longitude,
    time: new Date().toISOString()
  };

  await fetch(SHEET_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  alert("Submitted Successfully!");
  scannedData = null;
  preview.classList.add("hidden");
  scanBtn.classList.remove("hidden");
}

/* ================= INIT ================= */
renderLogin();
</script>

</body>
</html>
