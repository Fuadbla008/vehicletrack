<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR Scanner</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex justify-center items-center">
<div id="app" class="w-full max-w-md p-6"></div>

<script>
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxDWIVybQC_E5nAPrzgIF3SrOJdewkQaSuoQOxssrddr48L7zjprK2yDjDXSwZVxzi1/exec";

const users = [
  { username: "user1", password: "pass1" },
  { username: "user2", password: "pass2" },
  { username: "user3", password: "pass3" }
];

let currentUser = null;
let scannedData = null;
let qr = null;
let lat = "N/A";
let lon = "N/A";

function deviceId() {
  if (!localStorage.did)
    localStorage.did = "DEV-" + crypto.randomUUID();
  return localStorage.did;
}

function getLocation(cb) {
  if (!navigator.geolocation) return cb();
  navigator.geolocation.getCurrentPosition(
    p => {
      lat = p.coords.latitude;
      lon = p.coords.longitude;
      cb();
    },
    () => cb()
  );
}

function renderLogin() {
  app.innerHTML = `
    <h2 class="text-xl mb-4 text-center">Login</h2>
    <input id="u" class="w-full p-3 mb-2 bg-slate-800 rounded" placeholder="Username">
    <input id="p" type="password" class="w-full p-3 mb-3 bg-slate-800 rounded" placeholder="Password">
    <button onclick="login()" class="w-full bg-blue-600 p-3 rounded">Login</button>
    <p id="err" class="text-red-400 mt-2 text-center"></p>
  `;
}

function login() {
  const u = document.getElementById("u").value.trim();
  const p = document.getElementById("p").value.trim();
  const ok = users.find(x => x.username === u && x.password === p);
  if (!ok) return err.textContent = "Invalid Login";
  currentUser = u;
  renderScanner();
}

function renderScanner() {
  app.innerHTML = `
    <p class="mb-2">ðŸ‘¤ ${currentUser}</p>
    <button id="scanBtn" onclick="startScan()"
      class="w-full bg-green-600 p-3 rounded mb-3">Scan QR</button>

    <div id="reader"></div>

    <div id="preview" class="hidden mt-3">
      <div id="data" class="bg-slate-800 p-2 rounded mb-3"></div>
      <button onclick="submitData()"
        class="w-full bg-blue-600 p-3 rounded">Submit</button>
    </div>
  `;
}

function startScan() {
  qr = new Html5Qrcode("reader");
  qr.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    txt => {
      scannedData = txt;
      qr.stop();
      getLocation(() => {
        data.textContent = scannedData;
        preview.classList.remove("hidden");
      });
    }
  );
}

async function submitData() {
  if (!scannedData) return alert("No QR scanned");

  const res = await fetch(SHEET_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: currentUser,
      qr_data: scannedData,
      device_id: deviceId(),
      latitude: lat,
      longitude: lon
    })
  });

  const json = await res.json();
  if (!json.success) return alert("Submit failed");

  alert("Data Saved!");
  preview.classList.add("hidden");
}

renderLogin();
</script>
</body>
</html>
