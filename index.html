<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR Scanner</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex justify-center items-center">

<div id="app" class="w-full max-w-md p-6"></div>

<script>
/* ================= CONFIG ================= */
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxLDO53AxVjypgFuak_MiIr3bLjZFHCjiJEMSLSyMhTlOHUGzqik6OG4lCYW0bqTXT2/exec";

const users = [
  { username: "checker-in", password: "checker-in" },
  { username: "keysection", password: "keysection" },
  { username: "checker-out", password: "checker-out" }
];

/* ================= STATE ================= */
let currentUser = localStorage.getItem("user");
let qrScanner = null;
let scannedData = "";
let isScanning = false;
let isSubmitting = false;
let lat = "N/A";
let lon = "N/A";

/* ================= UTIL ================= */
function deviceId() {
  if (!localStorage.did) {
    localStorage.did = "DEV-" + Math.random().toString(36).substring(2);
  }
  return localStorage.did;
}

function getLocation(cb) {
  if (!navigator.geolocation) return cb();
  navigator.geolocation.getCurrentPosition(
    p => {
      lat = p.coords.latitude;
      lon = p.coords.longitude;
      cb();
    },
    () => cb()
  );
}

/* ================= LOGIN ================= */
function renderLogin() {
  app.innerHTML = `
    <h2 class="text-xl mb-4 text-center">Login</h2>
    <input id="u" class="w-full p-3 mb-2 bg-slate-800 rounded" placeholder="Username">
    <input id="p" type="password" class="w-full p-3 mb-3 bg-slate-800 rounded" placeholder="Password">
    <button onclick="login()" class="w-full bg-blue-600 p-3 rounded">Login</button>
    <p id="err" class="text-red-400 mt-2 text-center"></p>
  `;
}

function login() {
  const u = document.getElementById("u").value.trim();
  const p = document.getElementById("p").value.trim();
  const ok = users.find(x => x.username === u && x.password === p);

  if (!ok) {
    document.getElementById("err").textContent = "Invalid Login";
    return;
  }

  currentUser = u;
  localStorage.setItem("user", u);
  renderScanner();
}

async function logout() {
  await stopScanner();
  localStorage.removeItem("user");
  currentUser = null;
  renderLogin();
}

/* ================= SCANNER UI ================= */
function renderScanner() {
  app.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <p>ðŸ‘¤ ${currentUser}</p>
      <button onclick="logout()" class="text-red-400">Logout</button>
    </div>

    <button onclick="startScan()" class="w-full bg-green-600 p-3 rounded mb-3">
      Scan QR
    </button>

    <div id="reader" class="mb-3"></div>

    <div id="preview" class="hidden">
      <div id="data" class="bg-slate-800 p-2 rounded mb-3"></div>
      <button id="submitBtn"
        onclick="submitData()"
        class="w-full bg-blue-600 p-3 rounded">
        Submit
      </button>
    </div>
  `;
}

/* ================= SCANNER CORE ================= */
async function stopScanner() {
  if (qrScanner && isScanning) {
    try { await qrScanner.stop(); } catch {}
  }
  if (qrScanner) {
    qrScanner.clear();
    qrScanner = null;
  }
  isScanning = false;

  const reader = document.getElementById("reader");
  if (reader) reader.innerHTML = "";
}

async function startScan() {
  if (isScanning) return;

  scannedData = "";
  isSubmitting = false;

  document.getElementById("preview").classList.add("hidden");

  const reader = document.getElementById("reader");
  reader.innerHTML = "";

  await stopScanner();

  qrScanner = new Html5Qrcode("reader");
  isScanning = true;

  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async (text) => {
      if (!isScanning) return;

      scannedData = text;
      await stopScanner();

      getLocation(() => {
        document.getElementById("data").textContent = scannedData;
        document.getElementById("preview").classList.remove("hidden");
      });
    }
  );
}

/* ================= SUBMIT ================= */
function submitData() {
  if (isSubmitting || !scannedData) return;

  isSubmitting = true;
  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.textContent = "Submitting...";

  const form = new URLSearchParams();
  form.append("username", currentUser);
  form.append("qr_data", scannedData);
  form.append("device_id", deviceId());
  form.append("latitude", lat);
  form.append("longitude", lon);

  fetch(SHEET_API_URL, { method: "POST", body: form })
    .then(() => {
      alert("âœ… Data Saved Successfully!");
      scannedData = "";
      document.getElementById("preview").classList.add("hidden");
      document.getElementById("reader").innerHTML = "";
    })
    .catch(() => alert("âŒ Submit Failed"))
    .finally(() => {
      isSubmitting = false;
      btn.disabled = false;
      btn.textContent = "Submit";
    });
}

/* ================= INIT ================= */
currentUser ? renderScanner() : renderLogin();
</script>

</body>
</html>
