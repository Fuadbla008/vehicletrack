<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR Scanner</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex justify-center items-center">
<div id="app" class="w-full max-w-md p-6"></div>

<script>
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxLDO53AxVjypgFuak_MiIr3bLjZFHCjiJEMSLSyMhTlOHUGzqik6OG4lCYW0bqTXT2/exec";

const users = [
  { username: "user1", password: "pass1" },
  { username: "user2", password: "pass2" },
  { username: "user3", password: "pass3" }
];

let currentUser = null;
let scannedData = null;
let qr = null;
let lat = "N/A";
let lon = "N/A";

function deviceId() {
  if (!localStorage.did)
    localStorage.did = "DEV-" + Math.random().toString(36).substring(2);
  return localStorage.did;
}

function getLocation(cb) {
  if (!navigator.geolocation) return cb();
  navigator.geolocation.getCurrentPosition(
    p => {
      lat = p.coords.latitude;
      lon = p.coords.longitude;
      cb();
    },
    () => cb()
  );
}

function renderLogin() {
  app.innerHTML = `
    <h2 class="text-xl mb-4 text-center">Login</h2>
    <input id="u" class="w-full p-3 mb-2 bg-slate-800 rounded" placeholder="Username">
    <input id="p" type="password" class="w-full p-3 mb-3 bg-slate-800 rounded" placeholder="Password">
    <button onclick="login()" class="w-full bg-blue-600 p-3 rounded">Login</button>
    <p id="err" class="text-red-400 mt-2 text-center"></p>
  `;
}

function login() {
  const u = document.getElementById("u").value.trim();
  const p = document.getElementById("p").value.trim();
  const ok = users.find(x => x.username === u && x.password === p);
  if (!ok) return err.textContent = "Invalid Login";
  currentUser = u;
  renderScanner();
}

function renderScanner() {
  app.innerHTML = `
    <p class="mb-2">ğŸ‘¤ ${currentUser}</p>
    <button onclick="startScan()"
      class="w-full bg-green-600 p-3 rounded mb-3">Scan QR</button>

    <div id="reader"></div>

    <div id="preview" class="hidden mt-3">
      <div id="data" class="bg-slate-800 p-2 rounded mb-3"></div>
      <button onclick="submitData()"
        class="w-full bg-blue-600 p-3 rounded">Submit</button>
    </div>
  `;
}

function startScan() {
  qr = new Html5Qrcode("reader");
  qr.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    txt => {
      scannedData = txt;
      qr.stop();
      getLocation(() => {
        data.textContent = scannedData;
        preview.classList.remove("hidden");
      });
    }
  );
}

function submitData() {
  if (!scannedData) return alert("No QR scanned");

  const form = new URLSearchParams();
  form.append("username", currentUser);
  form.append("qr_data", scannedData);
  form.append("device_id", deviceId());
  form.append("latitude", lat);
  form.append("longitude", lon);

  fetch(SHEET_API_URL, {
    method: "POST",
    body: form
  })
  .then(() => {
    alert("âœ… Data Saved Successfully!");
    preview.classList.add("hidden");
  })
  .catch(() => alert("âŒ Submit Failed"));
}

renderLogin();
</script>
</body>
</html>
