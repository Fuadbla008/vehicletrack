<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR Scanner</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex justify-center items-center">
<div id="app" class="w-full max-w-md p-6"></div>

<script>
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxLDO53AxVjypgFuak_MiIr3bLjZFHCjiJEMSLSyMhTlOHUGzqik6OG4lCYW0bqTXT2/exec";

const users = [
  { username: "user1", password: "pass1" },
  { username: "user2", password: "pass2" },
  { username: "user3", password: "pass3" }
];

let currentUser = localStorage.getItem("user");
let scannedData = null;
let qr = null;
let lat = "N/A";
let lon = "N/A";
let isSubmitting = false; // ðŸ”’ double submit guard

/* ---------- Device ID ---------- */
function deviceId() {
  if (!localStorage.did)
    localStorage.did = "DEV-" + Math.random().toString(36).substring(2);
  return localStorage.did;
}

/* ---------- Location ---------- */
function getLocation(cb) {
  if (!navigator.geolocation) return cb();
  navigator.geolocation.getCurrentPosition(
    p => {
      lat = p.coords.latitude;
      lon = p.coords.longitude;
      cb();
    },
    () => cb()
  );
}

/* ---------- Login UI ---------- */
function renderLogin() {
  app.innerHTML = `
    <h2 class="text-xl mb-4 text-center">Login</h2>
    <input id="u" class="w-full p-3 mb-2 bg-slate-800 rounded" placeholder="Username">
    <input id="p" type="password" class="w-full p-3 mb-3 bg-slate-800 rounded" placeholder="Password">
    <button onclick="login()" class="w-full bg-blue-600 p-3 rounded">Login</button>
    <p id="err" class="text-red-400 mt-2 text-center"></p>
  `;
}

/* ---------- Login ---------- */
function login() {
  const u = document.getElementById("u").value.trim();
  const p = document.getElementById("p").value.trim();
  const ok = users.find(x => x.username === u && x.password === p);
  if (!ok) return err.textContent = "Invalid Login";

  currentUser = u;
  localStorage.setItem("user", u);
  renderScanner();
}

/* ---------- Logout ---------- */
function logout() {
  if (qr) {
    qr.stop().then(() => qr.clear()).catch(()=>{});
    qr = null;
  }
  localStorage.removeItem("user");
  currentUser = null;
  renderLogin();
}

/* ---------- Scanner UI ---------- */
function renderScanner() {
  app.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <p>ðŸ‘¤ ${currentUser}</p>
      <button onclick="logout()" class="text-red-400">Logout</button>
    </div>

    <button onclick="startScan()"
      class="w-full bg-green-600 p-3 rounded mb-3">Scan QR</button>

    <div id="reader" class="mb-3"></div>

    <div id="preview" class="hidden">
      <div id="data" class="bg-slate-800 p-2 rounded mb-3"></div>
      <button id="submitBtn"
        onclick="submitData()"
        class="w-full bg-blue-600 p-3 rounded">
        Submit
      </button>
    </div>
  `;
}

/* ---------- Start Scan ---------- */
function startScan() {
  scannedData = null;
  isSubmitting = false;
  preview.classList.add("hidden");

  if (qr) {
    qr.stop().then(() => qr.clear()).catch(()=>{});
  }

  qr = new Html5Qrcode("reader");

  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    txt => {
      scannedData = txt;
      qr.stop().then(() => qr.clear());
      getLocation(() => {
        data.textContent = scannedData;
        preview.classList.remove("hidden");
      });
    }
  );
}

/* ---------- Submit (Double Submit Safe) ---------- */
function submitData() {
  if (isSubmitting) return; // ðŸ”’ already submitting
  if (!scannedData) return alert("No QR scanned");

  isSubmitting = true;

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.textContent = "Submitting...";
  btn.classList.add("opacity-60");

  const form = new URLSearchParams();
  form.append("username", currentUser);
  form.append("qr_data", scannedData);
  form.append("device_id", deviceId());
  form.append("latitude", lat);
  form.append("longitude", lon);

  fetch(SHEET_API_URL, {
    method: "POST",
    body: form
  })
  .then(() => {
    alert("âœ… Data Saved Successfully!");
    scannedData = null;
    preview.classList.add("hidden");
  })
  .catch(() => {
    alert("âŒ Submit Failed");
  })
  .finally(() => {
    isSubmitting = false;
    btn.disabled = false;
    btn.textContent = "Submit";
    btn.classList.remove("opacity-60");
  });
}

/* ---------- App Init ---------- */
currentUser ? renderScanner() : renderLogin();
</script>
</body>
</html>
